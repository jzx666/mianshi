# 关于脚手架搭建

## 为什么需要脚手架？

提供一套模板把前端的一些基础建设如：代码风格检测，接口封装，代码编写模式，以及打包配置等直接一键生成。减少重复工作，建立团队中统一的开发模式。

## 一个项目基建需要做哪些事情？（vite + ts + vue3）

### vite项目初始化

``npm init vite@latest 项目名称 --template vue-ts``

### vite配置

```ts
//vite.config.ts
import AutoImport from "unplugin-auto-import/vite";
import Components from "unplugin-vue-components/vite";
import Icons from "unplugin-icons/vite";
import path from 'path'
import { ElementPlusResolver } from "unplugin-vue-components/resolvers";
import IconsResolver from "unplugin-icons/resolver";
import vue from "@vitejs/plugin-vue";
import { createSvgIconsPlugin } from 'vite-plugin-svg-icons';
import UnoCSS from 'unocss/vite'
import { type UserConfig, type ConfigEnv, loadEnv, defineConfig } from "vite";

const pathSrc = path.resolve(__dirname, "src");

export default defineConfig(({ command, mode }: ConfigEnv): UserConfig => {
  const env = loadEnv(mode, process.cwd());
  return {
    server: {
      host: "0.0.0.0",
      port: +env.VITE_APP_PORT,
      open: true,
      proxy: {
        // 代理 /dev-api 的请求
        [env.VITE_APP_BASE_API]: {
          changeOrigin: true,
          // 代理目标地址：https://api.youlai.tech
          target: env.VITE_APP_API_URL,
          rewrite: (path) => path.replace(new RegExp("^" + env.VITE_APP_BASE_API), ""),
        },
      },
    },
    //路径别名
    resolve: {
      alias: {
        '@': path.resolve(__dirname, 'src'),
      },
    },
    plugins: [
      vue(),
      UnoCSS({
        configFile: path.resolve(__dirname, 'uno.config.ts')
      }),
      AutoImport({
        // 自动导入 Vue 相关函数，如：ref, reactive, toRef 等
        imports: ["vue"],
        eslintrc: {
          enabled: false, // 是否自动生成 eslint 规则，建议生成之后设置 false 
          filepath: "./.eslintrc-auto-import.json", // 指定自动导入函数 eslint 规则的文件
        },
        dts: path.resolve(pathSrc, "types", "auto-imports.d.ts"), // 指定自动导入函数TS类型声明文件路径
      }),
      Components({
        resolvers: [
          // 自动导入 Element Plus 组件
          ElementPlusResolver(),
          // 自动注册图标组件
          IconsResolver({
            enabledCollections: ["ep"] // element-plus图标库，其他图标库 https://icon-sets.iconify.design/
          }),
        ],
        dts: path.resolve(pathSrc, "types", "components.d.ts"), // 指定自动导入组件TS类型声明文件路径
      }),
      Icons({
        // 自动安装图标库
        autoInstall: true,
      }),
      createSvgIconsPlugin({
        // 指定需要缓存的图标文件夹
        iconDirs: [path.resolve(process.cwd(), 'src/assets/icons')],
        // 指定symbolId格式
        symbolId: 'icon-[dir]-[name]',
      })
    ],
    css: {
      // CSS 预处理器
      preprocessorOptions: {
        //define global scss variable
        scss: {
          additionalData: `@use "@/styles/variables.scss" as *;`
        }
      }
    }
  }
})
```

###### **安装@types/node**

npm install @types/node --save-dev

###### **TypeScript 编译配置**

```json
//tsconfig.json
{
  "compilerOptions": {
    "target": "esnext",
    "module": "esnext",
    "moduleResolution": "node",
    "lib": ["esnext", "dom"],
    "baseUrl": ".",
    "paths": {
      "@/*": ["src/*"]
    },
    // 严格性和类型检查相关配置
    "strict": true,
    "skipLibCheck": true,
    "forceConsistentCasingInFileNames": true,
    // 调试和兼容性相关配置
    "sourceMap": true,
    "useDefineForClassFields": true,
    "allowJs": true,
    // 模块和兼容性相关配置
    "allowSyntheticDefaultImports": true,
    "esModuleInterop": true,
    "resolveJsonModule": true,
        // 类型声明相关配置
    "types": ["node", "vite/client", "element-plus/global"]
  },
  "include": ["mock/**/*.ts", "src/**/*.ts", "src/**/*.vue", "vite.config.ts"],
  "exclude": ["node_modules", "dist"]
}
```

### UI库 组件自动导入

为了避免在多个页面重复引入 `API` 或 `组件`，由此而产生的自动导入插件来节省重复代码和提高开发效率。

按照相关ui框架文档来，一般需要安装自动导入插件，并在vite.config.ts配置使用该插件。

### 整合UI库/图标库

安装相关包之后，需要配置vite.config.ts，设置相关自动导入。

### 整合scss

安装依赖 npm i -D sass 

配置vite.config.ts，设置css的预处理器preprocessorOptions选项。

### 整合 UnoCSS

安装依赖 npm install -D unocss

配置vite.config.ts，设置UnoCSS插件及其选项。

在`main.ts` 引入 `uno.css`。

安装vscode插件UnoCSS，使用智能提示。

增加配置文件uno.config.ts，内容可参考unocss官方文档。

##### 整合 Pinia

安装依赖 npm install pinia

`main.ts` 引入 `pinia`，createApp(App).use(createPinia()).mount("#app");

定义store： src/store/目录下

使用store

### 环境变量

env配置文件：项目根目录新建 `.env.development` 、`.env.production`

```properties
# 变量必须以 VITE_ 为前缀才能暴露给外部读取
VITE_APP_TITLE = 'vue3-element-admin'
VITE_APP_PORT = 3000
VITE_APP_BASE_API = '/dev-api'
```

环境变量智能提示: 新建 src/types/env.d.ts文件存放环境变量TS类型声明

```ts
// src/types/env.d.ts
interface ImportMetaEnv {
  /**
   * 应用标题
   */
  VITE_APP_TITLE: string;
  /**
   * 应用端口
   */
  VITE_APP_PORT: number;
  /**
   * API基础路径(反向代理)
   */
  VITE_APP_BASE_API: string;
}

interface ImportMeta {
  readonly env: ImportMetaEnv;
}
```

### 反向代理解决跨域

浏览器同源策略: 协议、域名和端口都相同是同源，浏览器会限制非同源请求读取响应结果。

本地开发环境通过 `Vite` 配置反向代理解决浏览器跨域问题，生产环境则是通过 `nginx` 配置反向代理 。

**`vite.config.ts` 配置代理**

### 整合 Axios

安装依赖 npm install axios

**Axios 工具类封装**

```ts
//  src/utils/request.ts
import axios, { InternalAxiosRequestConfig, AxiosResponse } from 'axios';
// import { useUserStoreHook } from '@/store/modules/user';

// 创建 axios 实例
const service = axios.create({
  baseURL: import.meta.env.VITE_APP_BASE_API,
  timeout: 50000,
  headers: { 'Content-Type': 'application/json;charset=utf-8' }
});

// 请求拦截器
service.interceptors.request.use(
  (config: InternalAxiosRequestConfig) => {
    // const userStore = useUserStoreHook();
    // if (userStore.token) {
    //   config.headers.Authorization = userStore.token;
    // }
    return config;
  },
  (error: any) => {
    return Promise.reject(error);
  }
);

// 响应拦截器
service.interceptors.response.use(
  (response: AxiosResponse) => {
    const { code, msg } = response.data;
    // 登录成功
    if (code === '00000') {
      return response.data;
    }

    // ElMessage.error(msg || '系统出错');
    return Promise.reject(new Error(msg || 'Error'));
  },
  (error: any) => {
    if (error.response.data) {
      const { code, msg } = error.response.data;
      // token 过期，跳转登录页
      if (code === 'A0230') {
        // ElMessageBox.confirm('当前页面已失效，请重新登录', '提示', {
        //   confirmButtonText: '确定',
        //   type: 'warning'
        // }).then(() => {
        //   localStorage.clear(); // @vueuse/core 自动导入
        //   window.location.href = '/';
        // });
      }else{
        //   ElMessage.error(msg || '系统出错');
      }
    }
    return Promise.reject(error.message);
  }
);

// 导出 axios 实例
export default service;
```

### vue-router

安装依赖 npm install vue-router@next

创建路由实例，顺带初始化静态路由，而动态路由需要用户登录，根据用户拥有的角色进行权限校验后进行初始化

```ts
// src/router/index.ts
import { createRouter, createWebHashHistory, RouteRecordRaw } from 'vue-router';

export const Layout = () => import('@/layout/index.vue');

// 静态路由
export const constantRoutes: RouteRecordRaw[] = [
  {
    path: '/redirect',
    component: Layout,
    meta: { hidden: true },
    children: [
      {
        path: '/redirect/:path(.*)',
        component: () => import('@/views/redirect/index.vue')
      }
    ]
  },

  {
    path: '/login',
    component: () => import('@/views/login/index.vue'),
    meta: { hidden: true }
  },

  {
    path: '/',
    component: Layout,
    redirect: '/dashboard',
    children: [
      {
        path: 'dashboard',
        component: () => import('@/views/dashboard/index.vue'),
        name: 'Dashboard',
        meta: { title: 'dashboard', icon: 'homepage', affix: true }
      }
    ]
  }
];

/**
 * 创建路由
 */
const router = createRouter({
  history: createWebHashHistory(),
  routes: constantRoutes as RouteRecordRaw[],
  // 刷新时，滚动条位置还原
  scrollBehavior: () => ({ left: 0, top: 0 })
});

/**
 * 重置路由
 */
export function resetRouter() {
  router.replace({ path: '/login' });
  location.reload();
}

export default router;
```

全局注册路由

```ts
// main.ts
import router from "@/router";

app.use(router).mount('#app')
```

### 国际化

国际化分为两个部分，ui框架的国际化，自定义国际化（vue-i18n插件）

**ui框架的国际化**

用框架指定的国际化组件包裹路由出口，组件会根据属性locale的值，匹配语言。

定义store：mudules/app.ts，读取配置文件@/setting的默认语言配置language，暴露语言的全局变量locale，改变方法changeLanguage。

切换语言组件调用store改变值。

**vue-i18n 自定义国际化**

安装依赖 npm install vue-i18n@9

自定义语言包 src/lang/package/en.json

创建i18n实例 

```ts
// src/lang/index.ts
import { createI18n } from 'vue-i18n';
import { useAppStore } from '@/store/modules/app';

const appStore = useAppStore();
// 本地语言包
import enLocale from './package/en';
import zhCnLocale from './package/zh-cn';

const messages = {
  'zh-cn': {
    ...zhCnLocale
  },
  en: {
    ...enLocale
  }
};
// 创建 i18n 实例
const i18n = createI18n({
  legacy: false,
  locale: appStore.language,
  messages: messages
});
// 导出 i18n 实例
export default i18n;
```

main.ts全局注册i18n

```ts
// 国际化
import i18n from '@/lang/index';

app.use(i18n).mount('#app');
```

### npm镜像源指定

配置.npmrc文件

```
registry=https://registry.npmmirror.com/

@cepdevops:registry=https://ptc-npm.pkg.coding.intlgame.com/costcenter/cepdevops/
always-auth=true
//ptc-npm.pkg.coding.intlgame.com/costcenter/cepdevops/:username=cepdevops-1704270765241
//ptc-npm.pkg.coding.intlgame.com/costcenter/cepdevops/:_password=YjY4NWMyMTU3ZjM4OTEyMmE3MDlkMzQ0ZTdlYjVmY2U4MjUwOTVhYg==

# pnpm把@vue/runtime-core从vue模块下提升至顶层依赖，才能对其进行全局组件类型声明扩展
public-hoist-pattern[]=@vue/runtime-core

# @vue/eslint-config-standard包的依赖，pnpm把其提升到顶层依赖eslint才不会失效
public-hoist-pattern[]=eslint-config-standard
public-hoist-pattern[]=eslint-import-resolver-custom-alias
public-hoist-pattern[]=eslint-import-resolver-node
public-hoist-pattern[]=eslint-plugin-import
public-hoist-pattern[]=eslint-plugin-n
public-hoist-pattern[]=eslint-plugin-promise
```

### Docker环境配置

配置Dockerfile文件

```dockerfile
FROM node:18-alpine
RUN npm install pnpm -g
COPY ./ /app
WORKDIR /app
RUN pnpm install && pnpm run build

FROM nginx
RUN mkdir /app
COPY --from=0 /app/dist /app
COPY nginx.conf /etc/nginx/nginx.conf
```

### nginx代理配置

```nginx
user  nginx;
worker_processes  4;
error_log  /var/log/nginx/error.log warn;
pid        /var/run/nginx.pid;
events {
  worker_connections  1024;
}
http {
  include       /etc/nginx/mime.types;
  default_type  application/octet-stream;
  log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';
  access_log  /var/log/nginx/access.log  main;
  sendfile        on;
  keepalive_timeout  65;
  server {
    listen       80;
    server_name  localhost;
    gzip_static on;
    location / {
      root   /app;
      index  index.html;
      try_files $uri $uri/ /index.html;
      add_header Access-Control-Allow-Origin *;
      add_header Access-Control-Allow-Methods 'GET, POST, OPTIONS, PUT, DELETE';
      add_header Access-Control-Allow-Headers 'DNT,X-Mx-ReqToken,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Authorization';
      add_header Access-Control-Allow-Credentials 'true';

      ## html不缓存
      if ($request_filename ~* .*\.(htm|html)$) 
      {
        add_header Cache-Control "no-store";
        add_header Access-Control-Allow-Origin *;
        add_header Access-Control-Allow-Methods 'GET, POST, OPTIONS, PUT, DELETE';
        add_header Access-Control-Allow-Headers 'DNT,X-Mx-ReqToken,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Authorization';
        add_header Access-Control-Allow-Credentials 'true';
      }

      if ($request_method = 'OPTIONS') {
        return 204;
      }
    }
    error_page   500 502 503 504  /50x.html;
    location = /50x.html {
      root   /usr/share/nginx/html;
    }
  }
}
```

### 规范配置

**代码统一规范**

- Eslint： JavaScript 语法规则和代码风格检查；

安装依赖 npm i -D eslint

配置文件 eslint.config.ts

添加ESLint 检测指令

```json
  "scripts": {
    "lint:eslint": "eslint \"src/**/*.{vue,ts,js}\" --fix"
  }
```

- Stylelint: CSS 统一规范和代码检测；

安装依赖 pnpm install -D stylelint stylelint-config-standard stylelint-config-recommended-scss stylelint-config-recommended-vue postcss postcss-html postcss-scss stylelint-config-recess-order stylelint-config-html

配置文件.stylelintrc.cjs， .stylelintignore

添加Stylelint检测指令

```json
  "scripts": {
      "lint:stylelint": "stylelint  \"**/*.{css,scss,vue,html}\" --fix"
  }
```

设置vscode保持自动检测

```json
//vscode/settings.json{
  "editor.codeActionsOnSave": {
    "source.fixAll.stylelint": true // 开启 Stylelint 保存自动检测
  },
  // Stylelint 校验文件
  "stylelint.validate": ["css", "scss", "vue", "html"]
}
```

- Prettier：全局代码格式化。

安装依赖 npm install -D prettier

配置文件.prettierignore，.prettierrc.yaml

添加prettier 格式化指令

```json
  "scripts": {
    "lint:prettier": "prettier --write \"**/*.{js,ts,json,css,less,scss,vue,html,md}\""
  }
```

设置vscode保持自动使用prettier格式化

```json
//vscode/settings.json
{
  "editor.formatOnSave": true, // 保存格式化文件
  "editor.defaultFormatter": "esbenp.prettier-vscode" // 指定 prettier 为所有文件默认格式化器
}
```

- EditorConfig编辑器配置

EditorConfig 主要用于统一不同 IDE 编辑器的编码风格。

安装vscode插件EditorConfig for VS Code

配置.EditorConfig文件

```editorconfig
# http://editorconfig.org
root = true

# 表示所有文件适用
[*]
charset = utf-8 # 设置文件字符集为 utf-8
end_of_line = lf # 控制换行类型(lf | cr | crlf)
indent_style = space # 缩进风格（tab | space）
indent_size = 2 # 缩进大小
insert_final_newline = true # 始终在文件末尾插入一个新行

# 表示仅 md 文件适用以下规则
[*.md]
max_line_length = off # 关闭最大行长度限制
trim_trailing_whitespace = false # 关闭末尾空格修剪
```

**Git提交规范**

- Husky + Lint-staged 整合实现 Git 提交前代码规范检测/格式化；
- Husky + Commitlint + Commitizen + cz-git 整合实现生成规范化且高度自定义的 Git commit message。

### 启动部署

项目启动

```bash
# 安装 pnpm
npm install pnpm -g

# 安装依赖
pnpm install

# 项目运行
pnpm run dev
```

项目部署

```bash
# 项目打包
pnpm run build:prod
```

生成的静态文件在工程根目录 dist 文件夹
